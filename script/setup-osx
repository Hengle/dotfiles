#!/usr/bin/env bash

set +e
proceed=1
result=0

DOTFILES_ROOT="$HOME/.dotfiles"
LOGFILE=/tmp/dotfiles-setup

. $DOTFILES_ROOT/script/shared-functions

if [[ $bootstrapping -ne 1 ]]; then
  header "Let's setup OSX with some apps ..."
fi

setup_macos_defaults() {
  # Ask for the administrator password upfront
  _title_ "We'll ask for your password once upfront..."
  sudo -v

  if [[ "$(get_yn_input "Would you like to hide icons on your desktop?" "y")" = "y" ]]; then
    hide_desktop_icons=1
  else
    hide_desktop_icons=0
  fi

  info "default settings for macOS : ${BOLD}installing${NORMAL}"
  hide_desktop_icons=$hide_desktop_icons $HOME/.dotfiles/osx/set-defaults.sh
  success "MacOS defaults : installed"
}

quicklook_plugins() {
  _title_ "macOS useful quicklook plugins"
  plugins=("qlcolorcode" "qlstephen" "qlmarkdown" "quicklook-json" "webpquicklook" "suspicious-package" "quicklookase" "qlvideo")
  for plugin in ${plugins[@]}; do
    check "quicklook plugin ${BOLD}$plugin${NORMAL}" "brew cask ls $plugin"
    successfully "brew cask install $app"
  done
}

choose_mac_apps_loop() {
  user "Would you like to install [a]ll, [n]one, or [s]ome of the apps? [a/n/s]?"
  read -n 1 input
  case "$input" in
    [aA][lL][lL] | [aA])
      chosen_apps=("${mac_apps[@]}")
      ;;
    [sS][oO][mM][eE] | [sS])
      echo ''
      echo ''
      for app in ${mac_apps[@]}; do
        if [[ "$(get_yn_input "Would you like to install ${BOLD}${app}${NORMAL}?" "y")" = "y" ]]; then
          chosen_apps=("${chosen_apps[@]}" "${app}")
        fi
      done
      ;;
    [nN][oO][nN][eE] | [nN])
      ;;
    *)
      info_no_spinner "Please choose ${BOLD}[a]${NORMAL}ll, ${BOLD}[n]${NORMAL}one, or ${BOLD}[s]${NORMAL}ome.\n"
      choose_mac_apps_loop
      ;;
  esac
}

install_mac_apps() {
  chosen_apps=() # When the user opts to install a package it will be added to this array.

  mac_apps=(
    # Browsers
    google-chrome firefox
    # Tools
    iterm2 nightowl gfxcardstatus alfred the-unarchiver
    # Zenjoy Essentials
    slack front harvest dropbox
    # Text Editors
    visual-studio-code
    # Entertainment
    vlc aerial fliqlo
  )

  info_no_spinner "We recommend installing the following apps:\n\n"
  for app in ${mac_apps[@]}; do
    echo " - ${BOLD}$app${NORMAL}"
  done
  echo ""
  
  choose_mac_apps_loop
  
  echo ''
  for app in ${chosen_apps[@]}; do
    # get executable name from cask to check if it is already installed
    executable=$(brew cask info $app | grep '(App)' | sed -E 's/(.*).app \(App\)/\1/')
    # check sudo or keep it alive before spinner starts
    sudo -v
    check "$app" "open -R -g -a '$executable' > /dev/null"
    successfully "brew cask install $app" "perhaps it is already installed."
  done
}

setup_iterm() {
  _title_ "Setup iTerm2 Profile"

  if ! open -R -g -a iTerm > /dev/null; then
    warn "iTerm2 not found, skipping setup..."
  else
    check "Fura Code Nerd font" "brew cask ls font-firacode-nerd-font"
    successfully "brew cask install font-firacode-nerd-font"

    destination="$HOME/Library/Application Support/iTerm2/DynamicProfiles/zenjoy.profile.plist"
    source="$HOME/.dotfiles/osx/iterm.profile.plist"
    if [[ -f "$destination" ]] || [[ -d "$destination" ]]; then
      if [[ "$(readlink "$destination")" -ef "$source" ]]; then
        success "${BOLD}~/`basename $source`${NORMAL} already installed"
      else
        link_files "$source" "$destination"
      fi
    else
      link_files "$source" "$destination"
    fi
    # dynamically load the profile on the fly
    echo -e "\033]50;SetProfile=Zenjoy\a"
  fi

  echo ''
  echo '  To setup the iTerm Profile, open iTerm:'
  echo '    Menu -> go into Iterm2 -> Preferences... go to Profiles and set the Zenjoy profile as default'
  echo '     (select Zenjoy dynamic profile -> click Other Actions -> Set as default)'
  echo ''
  echo '  The iTerm profile should automatically be loaded after restarting iTerm'
  echo ''
  echo '  To complete the iTerm TouchBar integration:'
  echo '    Menu -> go into View -> Customize Tool Bar... and drag & drop the Fn module on the Touchbar'
  echo ''
}

setup_macos_defaults
quicklook_plugins
install_mac_apps
setup_iterm

if [[ $bootstrapping -ne 1 ]]; then
  _title_ "Done... Have fun!"
fi